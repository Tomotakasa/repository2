rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper functions ───────────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function isCurrentUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function getGroup(groupId) {
      return get(/databases/$(database)/documents/groups/$(groupId)).data;
    }

    function isMemberOf(groupId) {
      return isAuthenticated() &&
        request.auth.uid in getGroup(groupId).members;
    }

    function isOwnerOf(groupId) {
      return isAuthenticated() &&
        getGroup(groupId).ownerId == request.auth.uid;
    }

    function isAdminOf(groupId) {
      let role = getGroup(groupId).members[request.auth.uid];
      return isAuthenticated() &&
        (role == 'owner' || role == 'admin');
    }

    // ─── Users collection ───────────────────────────────────────────
    // Each user can only read and write their own profile.
    // This protects openaiApiKey from being read by other users.
    match /users/{userId} {
      allow read:   if isCurrentUser(userId);
      allow create: if isCurrentUser(userId)
                    && request.resource.data.keys().hasAll(['displayName', 'email', 'groupIds', 'createdAt'])
                    && request.resource.data.displayName is string
                    && request.resource.data.email is string;
      allow update: if isCurrentUser(userId)
                    // Prevent privilege escalation — users cannot change their own uid
                    && !('uid' in request.resource.data.diff(resource.data).affectedKeys());
      allow delete: if false; // Accounts are managed via Firebase Auth
    }

    // ─── Groups collection ──────────────────────────────────────────
    match /groups/{groupId} {
      // Any member can read the group
      allow read: if isMemberOf(groupId);

      // Only authenticated users can create a group (as owner)
      allow create: if isAuthenticated()
                    && request.resource.data.ownerId == request.auth.uid
                    && request.auth.uid in request.resource.data.members
                    && request.resource.data.members[request.auth.uid] == 'owner';

      // Members can update group data (add/edit items forces update via sub-collection)
      // Only admins/owners can update the group document itself (children, categories, members)
      allow update: if isAdminOf(groupId)
                    // Prevent owner field from being changed
                    && (!('ownerId' in request.resource.data.diff(resource.data).affectedKeys())
                        || request.resource.data.ownerId == resource.data.ownerId);

      // Only the owner can delete a group
      allow delete: if isOwnerOf(groupId);

      // ── Items sub-collection ──────────────────────────────────────
      match /items/{itemId} {
        // Any group member can read items
        allow read: if isMemberOf(groupId);

        // Any member can create items
        allow create: if isMemberOf(groupId)
                      && request.resource.data.createdBy == request.auth.uid;

        // Any member can update items
        allow update: if isMemberOf(groupId);

        // Any member can delete items (admins + the creator)
        allow delete: if isMemberOf(groupId);
      }
    }

    // ─── Invite codes collection ────────────────────────────────────
    match /inviteCodes/{codeId} {
      // Any authenticated user can read a code (needed to validate before joining)
      allow read: if isAuthenticated();

      // Any group member can create invite codes for their group
      allow create: if isAuthenticated()
                    && isMemberOf(request.resource.data.groupId)
                    && request.resource.data.createdBy == request.auth.uid
                    && request.resource.data.usedCount == 0
                    && request.resource.data.isActive == true;

      // Only increment usedCount when joining (prevent tampering)
      allow update: if isAuthenticated()
                    && request.resource.data.usedCount == resource.data.usedCount + 1
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['usedCount']);

      // Code creator or group admin can delete
      allow delete: if isAuthenticated() &&
                    (resource.data.createdBy == request.auth.uid ||
                     isAdminOf(resource.data.groupId));
    }

  }
}
